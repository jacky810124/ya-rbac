'use strict';var _=require('lodash');var pathToRegexp=require('path-to-regexp');var permission=function permission(setting){var config=setting.config;var field=setting.field;var notLoggedIn=setting.notLoggedIn;var notAllowed=setting.notAllowed;var permissions=Object.keys(config).map(function(p){return{resource:pathToRegexp(p),actions:config[p]}});if(!notAllowed){notAllowed=function notAllowed(req,res,next){next({message:'Not allowed.'})}}if(!notLoggedIn){notLoggedIn=function notLoggedIn(req,res,next){next({message:'Not logged in.'})}}if(!field){field='user'}return function(req,res,next){var check=function check(actions,method,user){var action=actions[method];if(action&&!user){return notLoggedIn(req,res,next)}if(_.isArray(action)&&_.includes(action,user.role)){return next()}if(_.isBoolean(action)){return next()}if(method==='*'){return notAllowed(req,res,next)}return check(actions,'*',user)};var method=req.method.toUpperCase();var perm=_.find(permissions,function(p){var url=req.originalUrl.replace(/\?(\S|\s)*/gi,'');return url.match(p.resource)});if(!perm){return notAllowed(req,res,next)}return check(perm.actions,method,req[field])}};module.exports=permission;